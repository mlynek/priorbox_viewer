!function(a){"use strict";function b(b,c,d){function e(a){return W===V[a]}function f(a){if(a.length<1)return new r;for(var b=o(a[0].x,a[0].y),c=b,d=null,e=1;e<a.length;e++){if(d=o(a[e].x,a[e].y),d.equals(b)){c.next=b;break}c.next=d,c=d}return new r(b)}function g(a){if("undefined"==typeof a||null===a)return[];var b=[],c=a.getVertices();c[c.length-1].next===c[0]&&c.push(c[0]);for(var d=0;d<c.length;d++)b.push({x:c[d].position.x,y:c[d].position.y});return b}function h(){R=N.height/M.image.height*M.image.width<=N.width?N.height/M.image.height:N.width/M.image.width,T.x=M.image.width/2,T.y=M.image.height/2,P=!0,i()}function i(){if(P){P=!1;var b=O;b.clearRect(0,0,N.width,N.height),b.save();var c=N.width/2-T.x*R,d=N.height/2-T.y*R;if(b.translate(c,d),b.scale(R,R),b.drawImage(M.image,0,0),b.restore(),yb&&null!==M.solution&&s(b,M.solution),Ab&&M.annotations.forEach(function(a){s(b,a.polygon,a.color)}),(xb||zb)&&null!==ub&&ub.getLength()>0&&!ub.isClosed()){var e=ub.getLastVertex().position,f=m(sb);j(b,e,f,"#FF3300",U)}wb&&null!==M.answer&&x(b),k(b)}Q||a.requestAnimationFrame(i)}function j(a,b,c,d,e){a.save(),a.strokeStyle=d,a.lineWidth=e;var f=n(b),g={x:c.x-b.x,y:c.y-b.y},h={x:0,y:0};a.translate(f.x,f.y),a.scale(R,R),a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(g.x,g.y),a.stroke(),a.restore()}function k(a){var b,c=10,d=20,e=2*d+c,f=N.width-d-c,g=N.height-d-c;for(b=0;b<nb.length;b++)nb[b].draw(a,f,g-e*b,d);for(f=d+c,g=N.height-d-c,b=0;b<ob.length;b++)ob[b].draw(a,f,g-e*b,d);if(null!==pb){a.save(),a.globalAlpha=.5;var h=d;a.font=h+"px sans-serif";var i=a.measureText(pb).width,j=i+c,k=.7*h+c,m=N.width-(2*d+2*c)-j,n=N.height-k-c,o=m+.5*c,p=N.height-1.5*c;a.fillStyle="#000000",l(a,m,n,j,k,8,!0,!1),a.fillStyle="#ffffff",a.fillText(pb,o,p),a.restore()}}function l(a,b,c,d,e,f,g,h){f="number"==typeof f?f:5,g="boolean"==typeof g?g:!0,h="boolean"==typeof h?h:!1,a.beginPath(),a.moveTo(b+f,c),a.lineTo(b+d-f,c),a.quadraticCurveTo(b+d,c,b+d,c+f),a.lineTo(b+d,c+e-f),a.quadraticCurveTo(b+d,c+e,b+d-f,c+e),a.lineTo(b+f,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f),a.lineTo(b,c+f),a.quadraticCurveTo(b,c,b+f,c),a.closePath(),g&&a.fill(),h&&a.stroke()}function m(a){var b={x:T.x>=N.width/R/2?T.x-N.width/R/2:0,y:T.y>=N.height/R/2?T.y-N.height/R/2:0},c={x:T.x>=N.width/R/2?0:N.width/2-T.x*R,y:T.y>=N.height/R/2?0:N.height/2-T.y*R},d={};return d.x=b.x+a.x/R-c.x/R,d.y=b.y+a.y/R-c.y/R,d}function n(a){return{x:(a.x+N.width/R/2-T.x)*R,y:(a.y+N.height/R/2-T.y)*R}}function o(a,b,c){var d=new p(a,b,c);return d.onClick=function(){if(e("POLYGON_POINT_DELETE"))return null!==d.polygon&&(d.polygon.deleteVertex(d),d.polygon===M.solution?M.onSolutionChange(M.exportSolution()):(v(),M.onAnnotationChange(M.exportAnnotations())),P=!0),!1;if(e("POLYGON_DRAW")){var a=null!==d.polygon&&d.equals(d.polygon.initialVertex);if(a&&d.polygon.getLength()>2)return d.polygon.close(),W=V.DEFAULT,d.polygon===M.solution?M.onSolutionChange(M.exportSolution()):(v(),M.onAnnotationChange(M.exportAnnotations())),!1}return!0},d.onMouseDown=function(){return e("POLYGON_MOVE")?(qb=d.position,rb=!0,!0):!1},d}function p(a,b,c){this.position={x:a,y:b},this.polygon=c||null,this.next=null,this.handleWidth=12,this.onClick=function(){return!0},this.onMouseDown=function(){}}function q(a,b){a.save();var c=n(b.position);a.translate(c.x,c.y),a.fillStyle=b===tb&&b===ub.initialVertex&&e("POLYGON_DRAW")?"#FF6600":"#FFFFFF",a.strokeStyle="#000000",a.beginPath(),a.rect(-b.handleWidth/2,-b.handleWidth/2,b.handleWidth,b.handleWidth),a.stroke(),a.fill(),a.restore()}function r(a){var b=this;this.initialVertex=a||null,this.onMouseDown=function(){return!1},this.onClick=function(){return xb||zb?(ub=b,P=!0,!1):!0}}function s(a,b,c,d){if(null!==b.initialVertex&&null!==b.initialVertex.next){var e,f={x:0,y:0},g=b.initialVertex,h=n(b.initialVertex.position);a.save(),a.globalAlpha=.7,a.translate(h.x,h.y),a.scale(R,R),a.beginPath(),a.moveTo(f.x,f.y);do e=g.next,f={x:f.x+(e.position.x-g.position.x),y:f.y+(e.position.y-g.position.y)},a.lineTo(f.x,f.y),g=e;while(null!==g.next&&g!==b.initialVertex);a.fillStyle=c||"#0000FF",a.strokeStyle=d||"#66FF33",g===b.initialVertex&&(a.strokeStyle=d||"#000000",a.closePath(),a.fill()),a.lineWidth=U,a.stroke(),a.restore()}b===ub&&(xb||zb)&&b.getVertices().forEach(function(b){q(a,b)})}function t(a,b,c){return(b.x-a.x)*(c.y-a.y)-(c.x-a.x)*(b.y-a.y)}function u(a,b){var c={polygon:a||new r,color:b||Bb[(M.annotations.length+1)%Bb.length]};return M.annotations.push(c),c}function v(){M.annotations=M.annotations.filter(function(a){return"object"==typeof a.polygon&&"undefined"!=typeof a.polygon.isClosed?a.polygon.isClosed():!1})}function w(){var a="#0000ff";if(yb){var b=n(M.answer);a=null!==M.solution&&M.solution.isWithinBounds(b.x,b.y)?"#00ff00":"#ff0000"}return a}function x(a){a.save();var b=1.5,c=n(M.answer);a.translate(c.x,c.y),a.scale(b*R,b*R),a.shadowColor="#ffffff",a.shadowBlur=5,H(a,"",w(),0,0,50),a.restore()}function y(){var a=[];return a=a.concat(nb).concat(ob),(xb||zb)&&null!==ub&&(a=a.concat(ub.getVertices())),a=a.concat(M.annotations.map(function(a){return a.polygon})),null!==M.solution&&a.push(M.solution),a}function z(a){var b=N.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top},d=y().filter(function(a){return a.isWithinBounds(c.x,c.y)});return d.length>0?d[0]:null}function A(a){if(0===a.button){var b=z(a);null!==b&&b.onMouseDown(a)||(rb=!0)}}function B(a){0===a.button&&(qb=T,rb=!1)}function C(a){if(0===a.button){var b=z(a);if(null===b||b.onClick(a)){var c=N.getBoundingClientRect(),d={x:a.clientX-c.left,y:a.clientY-c.top};if(e("ANSWER_DRAW"))M.answer=m(d),P=!0;else if(e("POLYGON_DRAW")){if(a.shiftKey)null!==ub&&(ub.close(),W=V.DEFAULT,ub===M.solution?M.onSolutionChange(M.exportSolution()):(v(),M.onAnnotationChange(M.exportAnnotations())));else{var f=m(d),g=o(f.x,f.y);if(null===ub){if(!xb)return zb?void console.log("No active polygon. Click on a polygon to edit it!"):void console.log("invalid POLYGON_DRAW state");null===M.solution&&(M.solution=new r),ub=M.solution}ub.addVertex(g)}P=!0}else null!==ub&&(ub=null,P=!0)}}}function D(a){a||(a=event),a.preventDefault(),a.detail<0||a.wheelDelta>0?M.zoomOut():M.zoomIn()}function E(a){var b=N.getBoundingClientRect(),c={x:a.clientX-b.left,y:a.clientY-b.top};sb=sb||{x:0,y:0};var d=c.x-sb.x,e=c.y-sb.y;if(rb)qb===T?(qb.x-=d/R,qb.y-=e/R):(qb.x+=d/R,qb.y+=e/R,ub===M.solution?M.onSolutionChange(M.exportSolution()):(v(),M.onAnnotationChange(M.exportAnnotations()))),P=!0;else{var f=z(a),g=pb;null!==f?("undefined"!=typeof f.tooltip&&(pb=f.tooltip),f!==tb&&(tb=f)):(pb=null,null!==tb&&(tb=null)),g!==pb&&(P=!0)}sb=c,(xb||zb)&&(P=!0)}function F(a,b){this.drawPosition=null,this.drawRadius=0,this.alpha=.5,this.lineWidth=0,this.strokeStyle="#000000",this.color="#000000",this.icon=a,this.iconColor="#ffffff",this.tooltip=b||null,this.enabled=!1,this.enabledAlpha=.7,this.onClick=function(){return alert("no click action set!"),!0},this.onMouseDown=function(){return!1}}function G(a){var b=new F(null,"Change active annotation to this color");return b.color=a,b.lineWidth=1,b.enabled=function(){return zb&&null!==ub},b.onClick=function(){var b,c;if(null!==ub)for(c=!1,b=0;!c&&b<M.annotations.length;b++)ub===M.annotations[b].polygon&&(M.annotations[b].color=a,P=!0,c=!0)},b}function H(a,b,c,d,e,f){a.font=f+"px FontAwesome",a.fillStyle=c;var g=a.measureText(b),h=d-g.width/2,i=e+.7*f/2;a.fillText(b,h,i)}function I(a,b,c){a.addEventListener(b,c),X.push({eventTarget:a,eventType:b,listener:c})}function J(){var a,b,c=X.slice();for(a=0;a<c.length;a++)b=c[a],b.eventTarget.removeEventListener(b.eventType,b.listener);X=[]}function K(){I(document,"mousedown",A),I(document,"mouseup",B),I(N,"DOMMouseScroll",D),I(N,"mousewheel",D),I(N,"mousemove",E),I(N,"click",C)}function L(){M.image.addEventListener("load",h,!1),M.image.src=c,"[object Array]"===Object.prototype.toString.call(d.solution)&&M.importSolution(d.solution),"[object Array]"===Object.prototype.toString.call(d.annotations)&&M.importAnnotations(d.annotations),Y.onClick=function(){return M.zoomOut(),!1},Z.onClick=function(){return M.zoomIn(),!1},vb&&(_.onClick=function(){return M.answer=null,P=!0,!1},ab.enabled=function(){return e("ANSWER_DRAW")},ab.onClick=function(){return W=e("ANSWER_DRAW")?V.DEFAULT:V.ANSWER_DRAW,P=!0,!1},nb=$.concat(bb));var a=function(){return e("POLYGON_DRAW")},b=function(){return W=e("POLYGON_DRAW")?V.DEFAULT:V.POLYGON_DRAW,P=!0,!1},f=function(){return e("POLYGON_MOVE")},g=function(){return W=e("POLYGON_MOVE")?V.DEFAULT:V.POLYGON_MOVE,P=!0,!1},i=function(){return e("POLYGON_POINT_DELETE")},j=function(){return W=e("POLYGON_POINT_DELETE")?V.DEFAULT:V.POLYGON_POINT_DELETE,P=!0,!1};xb&&(cb.enabled=a,cb.onClick=b,db.enabled=f,db.onClick=g,eb.enabled=i,eb.onClick=j,fb.onClick=function(){return M.solution=ub=null,M.onSolutionChange(M.exportSolution()),P=!0,!1},nb=$.concat(gb)),zb&&(hb.enabled=function(){return zb},hb.onClick=function(){v();var a=u();return ub=a.polygon,W=V.POLYGON_DRAW,!1},ib.enabled=a,ib.onClick=b,jb.enabled=f,jb.onClick=g,kb.enabled=i,kb.onClick=j,lb.onClick=function(){for(var a=-1,b=0;b<M.annotations.length;b++)if(M.annotations[b].polygon===ub){a=b;break}return a>-1?(M.annotations.splice(a,1),ub=null,P=!0,v(),M.onAnnotationChange(M.exportAnnotations()),!1):!0},nb=$.concat(mb),ob=Bb.map(function(a){return G(a)})),K()}var M=this;d="object"==typeof d?d:{},d.mode="string"==typeof d.mode?d.mode:"";var N=document.getElementById(b),O=N.getContext("2d"),P=!0,Q=!1,R=1,S=.1,T={x:0,y:0},U=3,V={DEFAULT:0,ANSWER_DRAW:1,POLYGON_DRAW:2,POLYGON_MOVE:3,POLYGON_POINT_DELETE:4,ANNOTATION_DISPLAY:5},W=V.DEFAULT,X=[],Y=new F("","Zoom out"),Z=new F("","Zoom in"),$=[Y,Z],_=new F("","Delete answer"),ab=new F("","Set answer"),bb=[_,ab],cb=new F("","Draw new solution point (close with shift-click)"),db=new F("","Move solution point"),eb=new F("","Delete solution point"),fb=new F("","Delete solution"),gb=[fb,eb,db,cb],hb=new F("","Start drawing a new annotation"),ib=new F("","Draw new annotation point (close with shift-click)"),jb=new F("","Move annotation point"),kb=new F("","Delete annotation point"),lb=new F("","Delete active annotation"),mb=[lb,kb,jb,ib,hb],nb=$.slice(),ob=[],pb=null,qb=T,rb=!1,sb=null,tb=null,ub=null,vb="editAnswer"===d.mode,wb=vb||"showSolution"===d.mode,xb="editSolution"===d.mode,yb=xb||"showSolution"===d.mode,zb="editAnnotations"===d.mode,Ab=zb||"showAnnotations"===d.mode,Bb=["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462"];this.image=new Image,this.answer="object"==typeof d.answer&&null!==d.answer?d.answer:null,this.solution=null,this.annotations=[],this.exportSolution=function(){return g(this.solution)},this.importSolution=function(a){this.solution=ub=a.length>=1?f(a):null,P=!0},this.exportAnnotations=function(){return this.annotations.map(function(a){return{color:a.color,polygon:g(a.polygon)}})},this.importAnnotations=function(a){a.forEach(function(a){u(f(a.polygon),a.color)})},this.onSolutionChange=function(){},this.onAnnotationChange=function(){},this.zoomIn=function(){R*=1+S,P=!0},this.zoomOut=function(){R*=1-S,P=!0},p.prototype.equals=function(a){return this.position.x===a.position.x&&this.position.y===a.position.y},p.prototype.isWithinBounds=function(a,b){var c=n(this.position);return a>=c.x-this.handleWidth/2&&a<=c.x+this.handleWidth/2&&b>=c.y-this.handleWidth/2&&b<=c.y+this.handleWidth/2},r.prototype.addVertex=function(a){if(null!==this.initialVertex){for(var b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next;b.next=a}else this.initialVertex=a;a.polygon=this,P=!0},r.prototype.deleteVertex=function(a){if(null!==this.initialVertex&&this.initialVertex.equals(a))this.initialVertex=this.initialVertex.next;else for(var b=!1,c=this.initialVertex,d=c.next;!b&&null!==d&&d!==this.initialVertex;)d.equals(a)?(c.next=d.next,b=!0):(c=d,d=c.next)},r.prototype.getVertices=function(){for(var a=[],b=this.initialVertex;null!==b;)-1===a.indexOf(b)&&a.push(b),b=b.next!==this.initialVertex?b.next:null;return a},r.prototype.isClosed=function(){var a=this.initialVertex;if(null===a)return!1;for(var b=0;null!==a.next&&a.next!==this.initialVertex;)a=a.next,b++;return a.next===this.initialVertex&&b>1},r.prototype.getLastVertex=function(){var a=this.initialVertex;if(null===a)return null;for(;null!==a.next&&a.next!==this.initialVertex;)a=a.next;return a},r.prototype.getLength=function(){if(null===this.initialVertex)return 0;for(var a=1,b=this.initialVertex;null!==b.next&&b.next!==this.initialVertex;)b=b.next,a++;return a},r.prototype.isWithinBounds=function(a,b){var c=this.getVertices(),d=0,e=m({x:a,y:b});if(c.length<3||c[c.length-1].next!==c[0])return!1;c.push(c[0]);for(var f=0;f+1<c.length;f++)c[f].position.y<=e.y?c[f+1].position.y>e.y&&t(c[f].position,c[f+1].position,e)>0&&d++:c[f+1].position.y<=e.y&&t(c[f].position,c[f+1].position,e)<0&&d--;return 0!==d},r.prototype.close=function(){this.getVertices().length>2&&this.addVertex(this.initialVertex)},F.prototype.isWithinBounds=function(a,b){if(null===this.drawPosition)return!1;var c=Math.abs(this.drawPosition.x-a),d=Math.abs(this.drawPosition.y-b);return c*c+d*d<=this.drawRadius*this.drawRadius},F.prototype.draw=function(a,b,c,d){this.drawPosition={x:b,y:c},this.drawRadius=d,a.save();var e="function"==typeof this.enabled?this.enabled():this.enabled;a.globalAlpha=e?this.enabledAlpha:this.alpha,a.fillStyle=this.color,a.lineWidth=0,a.beginPath(),a.arc(b,c,d,0,2*Math.PI),a.closePath(),a.fill(),this.lineWidth>0&&(a.lineWidth=this.lineWidth,a.strokeStyle=this.strokeStyle,a.stroke()),null!==this.icon&&(a.save(),a.globalCompositeOperation="destination-out",H(a,this.icon,this.iconColor,b,c,d),a.restore()),a.restore()},this.dispose=function(){J(),Q=!0},this.refresh=function(){M.dirty=!0},L()}a.ImageViewer=b}(window);
//# sourceMappingURL=viewer.min.js.map